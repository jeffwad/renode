/**

  @module       app/models/BaseModel
  @description  base model object
  @todo         accessors

*/
var utils      = require('lib/utils'),
    Base       = require('lib/Base'),
    iter       = require('lib/iter'),
    Collection = require('app/models/Collection'),
    forEach    = iter.forEach;



module.exports = Base.create({

  //  properties

  /**
    @description  accessors
  */
  accessors: {

    id: {
      type: 'string'
    }
  },


  //  constructor

  /**
    @description  constructor
  */
  __init__: function() {

    Base.__init__.apply(this);

    Object.defineProperty(this, "_data", {
      value: {}
    });

    this._initAccessors();
    this._initHasMany();
    this.id = utils.generateId();

  },


  //  private


  _createAccessor: function(name, definition) {

    //  create the getters and setters
    Object.defineProperty(this, name, {

      get: function() {

        return this._data[name];

      },

      set: function(value) {

        if (definition.type) {
          if (typeof value !== definition.type) {
            if (!definition.type.isPrototypeOf(value)) {
              throw Error.spawn("accessor (" + name + ") does not accept data: " + value);
            }
          }
        }

        this._data[name] = value;

      },
      enumerable: true
    });

    if (typeof definition.defaultValue !== "undefined") {
      this[name] = definition.defaultValue;
    }

  },


  /**
    @description  sets up the accessors on the model
                  recursing through all the inherited models
    @param        {object} object
  */
  _initAccessors: function(object) {

    var proto;

    object = object || this;

    if(object.hasOwnProperty('accessors')) {

      forEach(object.accessors, function(accessor, name) {

        if(!this.hasOwnProperty(name)) {

          //  set the accessor definition
          Object.defineProperty(this, '__' + name, {

            value: accessor,
            enumerable: false

          });

          //  create the accessor
          this._createAccessor(name, accessor);

        }

      }, this);

    }

    proto = Object.getPrototypeOf(object);
    if(proto && proto.hasOwnProperty('accessors')) {
      this._initAccessors(proto);
    }


  },


  /**
    @description  sets up the accessor hasMany relationships on the model,
                  recursing through all the inherited models
    @param        {object} object
  */
  _initHasMany: function(object) {

    var proto;

    object = object || this;

    if(object.hasOwnProperty('hasMany')) {

      forEach(object.hasMany, function(relation, name) {

        if(!this.hasOwnProperty(name)) {

          //  create the accessor
          this._createAccessor(name, {
            'defaultValue': Collection.spawn(relation.model),
            'type'        : Collection
          });

          //  create the factory method
          Object.defineProperty(this, relation.factory, {

            value: function(data) {

              this[name].add(relation.model.spawn(data));

            },
            enumerable: false

          });

        }

      }, this);

    }

    proto = Object.getPrototypeOf(object);
    if(proto && proto.hasOwnProperty('hasMany')) {
      this._initHasMany(proto);
    }


  }

});